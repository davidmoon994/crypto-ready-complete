<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä»ªè¡¨ç›˜</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .navbar h1 { color: #667eea; font-size: 24px; }
        .navbar button { padding: 8px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: #ff6b6b; color: white; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #333; }
        .stat-card .value.positive { color: #10b981; }
        .stat-card .value.negative { color: #ef4444; }
        .section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section h2 { margin-bottom: 20px; color: #333; }
        .btn { padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 5px; }
        .btn:hover { transform: translateY(-2px); }
        table { width: 100%; border-collapse: collapse; }
        table th { text-align: left; padding: 15px; background: #f8f9fa; font-weight: 600; color: #666; }
        table td { padding: 15px; border-bottom: 1px solid #e9ecef; }
        table tr:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸ“Š æˆ‘çš„ä»ªè¡¨ç›˜</h1>
        <div>
            <span id="userPhone"></span>
            <span id="userStatus" style="margin: 0 15px;"></span> <!-- æ–°å¢ -->
            <button class="btn" onclick="refresh()">ğŸ”„ åˆ·æ–°</button>
            <button onclick="logout()">é€€å‡º</button>
        </div>
    </div>
    <div class="container">
        <!-- åŸæœ‰çš„4ä¸ªç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>æ€»å……å€¼</h3>
                <div class="value" id="totalRecharge">$0</div>
            </div>
            <div class="stat-card">
                <h3>å½“å‰ä»·å€¼</h3>
                <div class="value" id="currentValue">$0</div>
            </div>
            <div class="stat-card">
                <h3>æ€»ç›ˆäº</h3>
                <div class="value" id="totalProfit">$0</div>
            </div>
            <div class="stat-card">
                <h3>ç´¯è®¡æ”¶ç›Šç‡</h3>
                <div class="value" id="profitRate">0%</div>
            </div>
        </div>
    
        <!-- æ–°å¢ï¼šå¹´åŒ–ç‡ç»Ÿè®¡ -->
        <div class="section" style="margin-top: 20px;">
            <h2>ğŸ“ˆ æ”¶ç›Šç‡åˆ†æ</h2>
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="opacity: 0.9;">æœˆåŒ–ç‡</h3>
                    <div class="value" id="monthlyRate">0%</div>
                    <small style="opacity: 0.8; font-size: 12px;">åŸºäºå¹³å‡æŒæœ‰å¤©æ•°</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <h3 style="opacity: 0.9;">å­£åº¦åŒ–ç‡</h3>
                    <div class="value" id="quarterlyRate">0%</div>
                    <small style="opacity: 0.8; font-size: 12px;">90å¤©é¢„æœŸæ”¶ç›Š</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <h3 style="opacity: 0.9;">å¹´åŒ–ç‡</h3>
                    <div class="value" id="annualRate">0%</div>
                    <small style="opacity: 0.8; font-size: 12px;">365å¤©é¢„æœŸæ”¶ç›Š</small>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡æŒæœ‰</h3>
                    <div class="value" id="avgHoldDays">0å¤©</div>
                    <small style="color: #999; font-size: 12px;">æ‰€æœ‰å……å€¼çš„å¹³å‡å¤©æ•°</small>
                </div>
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 15px;">
                <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>åŒ–ç‡åŸºäºå½“å‰ç´¯è®¡æ”¶ç›Šç‡å’Œå¹³å‡æŒæœ‰å¤©æ•°è®¡ç®—</li>
                    <li>æœˆåŒ–ç‡ = æ—¥åŒ–ç‡ Ã— 30ï¼Œå­£åº¦åŒ–ç‡ = æ—¥åŒ–ç‡ Ã— 90ï¼Œå¹´åŒ–ç‡ = æ—¥åŒ–ç‡ Ã— 365</li>
                    <li>ä»…ä¾›å‚è€ƒï¼Œè¿‡å¾€è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Š</li>
                </ul>
            </div>
        </div>
    
        
        <div class="section">
            <h2>æˆ‘çš„å……å€¼è®°å½•</h2>
            <table><thead><tr><th>å……å€¼æ—¶é—´</th><th>é‡‘é¢</th><th>å¸ç§</th><th>å……å€¼åˆ°</th><th>å½“å‰ç›ˆäº</th><th>ç›ˆäºç‡</th><th>æ“ä½œ</th></tr></thead><tbody id="rechargesBody"></tbody></table>
        </div>
    </div>
    
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3 id="historyTitle">å……å€¼å†å²</h3>
            <table><thead><tr><th>æ—¥æœŸ</th><th>è´¦æˆ·ä½™é¢</th><th>ç›ˆäºé‡‘é¢</th><th>ç›ˆäºç‡</th></tr></thead><tbody id="historyBody"></tbody></table>
            <button class="btn" onclick="closeHistoryModal()">å…³é—­</button>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin + '/api';
        let authHeader = '';
        
        function checkAuth() {
    const phone = localStorage.getItem('phone');
    const password = localStorage.getItem('password');
    const isActive = localStorage.getItem('isActive');
    
    if (!phone || !password) {
        window.location.href = '/';
        return false;
    }
    
    authHeader = 'Basic ' + btoa(phone + ':' + password);
    document.getElementById('userPhone').textContent = phone;
    
    // æ˜¾ç¤ºè´¦æˆ·çŠ¶æ€
    if (isActive === 'false') {
        document.getElementById('userStatus').innerHTML = 
            '<span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">è´¦æˆ·å·²åœç”¨</span>';
    }
    
    return true;
}
        
        async function loadSummary() {
    const response = await fetch(`${API_URL}/dashboard/summary`, { 
        headers: { 'Authorization': authHeader } 
    });
    
    if (response.ok) {
        const data = await response.json();
        
        // åŸæœ‰çš„4ä¸ªå¡ç‰‡
        document.getElementById('totalRecharge').textContent = '$' + data.total_recharge.toFixed(2);
        document.getElementById('currentValue').textContent = '$' + data.current_value.toFixed(2);
        
        const profit = document.getElementById('totalProfit');
        profit.textContent = (data.total_profit >= 0 ? '+' : '') + '$' + data.total_profit.toFixed(2);
        profit.className = 'value ' + (data.total_profit >= 0 ? 'positive' : 'negative');
        
        const rate = document.getElementById('profitRate');
        rate.textContent = (data.total_profit_rate >= 0 ? '+' : '') + data.total_profit_rate.toFixed(2) + '%';
        rate.className = 'value ' + (data.total_profit_rate >= 0 ? 'positive' : 'negative');
        
        // æ–°å¢ï¼šåŒ–ç‡æ˜¾ç¤º
        const monthlyRate = document.getElementById('monthlyRate');
        monthlyRate.textContent = (data.monthly_rate >= 0 ? '+' : '') + data.monthly_rate.toFixed(2) + '%';
        
        const quarterlyRate = document.getElementById('quarterlyRate');
        quarterlyRate.textContent = (data.quarterly_rate >= 0 ? '+' : '') + data.quarterly_rate.toFixed(2) + '%';
        
        const annualRate = document.getElementById('annualRate');
        annualRate.textContent = (data.annual_rate >= 0 ? '+' : '') + data.annual_rate.toFixed(2) + '%';
        
        document.getElementById('avgHoldDays').textContent = data.avg_hold_days + 'å¤©';
    }
}
        
        async function loadRecharges() {
            const response = await fetch(`${API_URL}/dashboard/recharges`, { headers: { 'Authorization': authHeader } });
            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('rechargesBody');
                if (!data.recharges || data.recharges.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">æš‚æ— å……å€¼è®°å½•</td></tr>';
                    return;
                }
                tbody.innerHTML = data.recharges.map(r => `
                    <tr>
                        <td>${new Date(r.recharge.recharge_at).toLocaleDateString('zh-CN')}</td>
                        <td>$${r.recharge.amount.toFixed(2)}</td>
                        <td>${r.recharge.currency}</td>
                        <td><strong>${r.account_type}</strong></td>
                        <td style="color: ${r.current_profit >= 0 ? '#10b981' : '#ef4444'}">
                            ${r.current_profit >= 0 ? '+' : ''}$${r.current_profit.toFixed(2)}
                        </td>
                        <td style="color: ${r.current_rate >= 0 ? '#10b981' : '#ef4444'}">
                            ${r.current_rate >= 0 ? '+' : ''}${r.current_rate.toFixed(2)}%
                        </td>
                        <td><button class="btn" onclick="viewHistory(${r.recharge.id}, '${r.account_type}', ${r.recharge.amount})">æŸ¥çœ‹å†å²</button></td>
                    </tr>
                `).join('');
            }
        }
        
        async function viewHistory(rechargeId, accountType, amount) {
            document.getElementById('historyTitle').textContent = `å……å€¼å†å² - ${accountType} $${amount}`;
            document.getElementById('historyModal').classList.add('active');
            const response = await fetch(`${API_URL}/dashboard/recharge/${rechargeId}/history`, { headers: { 'Authorization': authHeader } });
            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('historyBody');
                if (!data.history || data.history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">æš‚æ— å†å²æ•°æ®</td></tr>';
                    return;
                }
                tbody.innerHTML = data.history.map(h => `
                    <tr>
                        <td>${h.record_date}</td>
                        <td>$${h.admin_account_balance.toFixed(2)}</td>
                        <td style="color: ${h.profit >= 0 ? '#10b981' : '#ef4444'}">
                            ${h.profit >= 0 ? '+' : ''}$${h.profit.toFixed(2)}
                        </td>
                        <td style="color: ${h.profit_rate >= 0 ? '#10b981' : '#ef4444'}">
                            ${h.profit_rate >= 0 ? '+' : ''}${h.profit_rate.toFixed(2)}%
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        function closeHistoryModal() { document.getElementById('historyModal').classList.remove('active'); }
        
        async function refresh() {
            await fetch(`${API_URL}/dashboard/refresh`, {
                method: 'POST',
                headers: { 'Authorization': authHeader }
            });
            loadSummary();
            loadRecharges();
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        if (checkAuth()) {
            loadSummary();
            loadRecharges();
            setInterval(() => { loadSummary(); loadRecharges(); }, 30000);
        }
    </script>
</body>
</html>
