<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>ç®¡ç†åå°</title>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
    
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 15px;
        }
    
        .navbar h1 {
            font-size: 24px;
            margin: 0;
        }
    
        .navbar-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
    
        .section {
            background: white;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
    
        .section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
    
        /* é’±åŒ…ç½‘æ ¼ */
        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
    
        .wallet-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
    
        .wallet-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, #d4f4dd 0%, #e8f5e9 100%);
        }
    
        .wallet-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #667eea;
        }
    
        .wallet-balance {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
    
        /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
    
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }
    
        /* è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
    
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
    
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
            white-space: nowrap;
        }
    
        td {
            color: #333;
        }
    
        tr:hover {
            background: #f8f9fa;
        }
    
        /* æŒ‰é’® */
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
    
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
    
        .btn:active {
            transform: translateY(0);
        }
    
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
    
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            margin: 40px auto;
            max-height: 90vh;
            overflow-y: auto;
        }
    
        .form-group {
            margin-bottom: 20px;
        }
    
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
    
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
    
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
    
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #999;
            font-size: 12px;
        }
    
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
    
        .badge.active {
            background: #d4edda;
            color: #155724;
        }
    
        .badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }
    
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .navbar {
                padding: 15px;
            }
    
            .navbar h1 {
                font-size: 20px;
                width: 100%;
            }
    
            .navbar-buttons {
                width: 100%;
                justify-content: flex-start;
            }
    
            .container {
                padding: 10px;
            }
    
            .section {
                padding: 15px;
                margin-bottom: 15px;
            }
    
            .section h2 {
                font-size: 18px;
            }
    
            .wallet-grid {
                grid-template-columns: 1fr;
            }
    
            .stats-grid {
                grid-template-columns: 1fr;
            }
    
            .wallet-balance {
                font-size: 24px;
            }
    
            table {
                font-size: 13px;
            }
    
            th, td {
                padding: 8px 6px;
            }
    
            .btn {
                padding: 8px 15px;
                font-size: 13px;
            }
    
            .modal-content {
                padding: 20px;
                margin: 20px auto;
            }
    
            .modal.active {
                align-items: flex-start;
                padding: 10px;
            }
        }
    
        @media (max-width: 480px) {
            .navbar h1 {
                font-size: 18px;
            }
    
            .section h2 {
                font-size: 16px;
            }
    
            .wallet-balance {
                font-size: 20px;
            }
    
            table {
                font-size: 12px;
                min-width: 500px;
            }
    
            th, td {
                padding: 6px 4px;
            }
    
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
    
            .modal-content {
                padding: 15px;
            }
        }
    
        /* æ¨ªå±æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 900px) and (orientation: landscape) {
            .modal-content {
                max-height: 85vh;
            }
        }
        /* è¡¨æ ¼å“åº”å¼ä¼˜åŒ– */
.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -15px; /* è´Ÿè¾¹è·è®©è¡¨æ ¼å¯ä»¥æ»šåŠ¨åˆ°è¾¹ç¼˜ */
    padding: 0 15px;
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
}

/* æ‰‹æœºç«¯éšè—æ¬¡è¦åˆ— */
@media (max-width: 768px) {
    .hide-mobile {
        display: none;
    }
    
    table {
        min-width: 100%;
        font-size: 12px;
    }
    
    th, td {
        padding: 8px 4px;
        font-size: 12px;
    }
    
    /* æ‰‹æœºç«¯æ˜¾ç¤ºå¡ç‰‡å¼å¸ƒå±€ */
    .mobile-card {
        display: block;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .mobile-card-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .mobile-card-row:last-child {
        border-bottom: none;
    }
    
    .mobile-card-label {
        color: #666;
        font-weight: 600;
        font-size: 12px;
    }
    
    .mobile-card-value {
        color: #333;
        font-size: 13px;
        font-weight: 500;
    }
}
    </style>
</head>
<body>
    <div class="navbar">
        <h1>âš™ï¸ ç®¡ç†åå°</h1>
        <div class="navbar-buttons">
            <button class="btn" onclick="showConfigModal()">âš™ï¸ é…ç½®é’±åŒ…</button>
            <button class="btn" onclick="manualCheck()">ğŸ”„ æ‰‹åŠ¨æ£€æŸ¥ä½™é¢</button>
            <button class="btn" onclick="logout()">é€€å‡º</button>
        </div>
    </div>

    <div class="container">
        <!-- 1. é’±åŒ…çŠ¶æ€æ€»è§ˆ (å¿…é¡»æœ‰!) -->
        <div class="section">
            <h2>ğŸ’¼ é’±åŒ…çŠ¶æ€æ€»è§ˆ</h2>
            <div id="walletGrid" class="wallet-grid">
                <div style="padding: 40px; text-align: center; color: #999;">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- 2. å……å€¼ç»Ÿè®¡æ€»è§ˆ -->
        <div class="section">
            <h2>ğŸ“Š å……å€¼ç»Ÿè®¡æ€»è§ˆ</h2>
            <div id="rechargeStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="padding: 20px; text-align: center; color: #999;">åŠ è½½ä¸­...</div>
            </div>
        </div>
            
            <div class="section">
                <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="showCreateUserModal()">â• åˆ›å»ºç”¨æˆ·</button>
                    <button class="btn" onclick="showRechargeModal()">ğŸ’° å……å€¼</button>
                </div>
                
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>æ‰‹æœºå·</th>
                                <th class="hide-mobile">æ€»å……å€¼</th>
                                <th class="hide-mobile">å½“å‰ä»·å€¼</th>
                                <th>ç›ˆäº</th>
                                <th class="hide-mobile">ç¬”æ•°</th>
                                <th class="hide-mobile">çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </div>
    
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h3>âš™ï¸ é’±åŒ…é…ç½®</h3>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                â„¹ï¸ é…ç½®ä¸€æ¬¡åå°†æ°¸ä¹…ä¿å­˜ï¼Œé™¤éæ‰‹åŠ¨ä¿®æ”¹ã€‚APIå¯†é’¥å·²åŠ å¯†å­˜å‚¨ã€‚
            </p>
            
            <form id="binanceForm" onsubmit="saveConfig(event, 'Binance')">
                <h4>ğŸ…±ï¸ Binance</h4>
                <div class="form-group">
                    <label>API Key</label>
                    <input id="binance_key" type="password" placeholder="è¾“å…¥Binance API Key">
                    <small style="color: #999;">é¦–æ¬¡é…ç½®æˆ–éœ€è¦ä¿®æ”¹æ—¶å¡«å†™</small>
                </div>
                <div class="form-group">
                    <label>API Secret</label>
                    <input id="binance_secret" type="password" placeholder="è¾“å…¥Binance API Secret">
                </div>
                <button type="submit" class="btn">ğŸ’¾ ä¿å­˜Binanceé…ç½®</button>
            </form>
            <hr style="margin: 20px 0;">
            
            <form id="okxForm" onsubmit="saveConfig(event, 'OKX')">
                <h4>ğŸ…¾ï¸ OKX</h4>
                <div class="form-group">
                    <label>API Key</label>
                    <input id="okx_key" type="password" placeholder="è¾“å…¥OKX API Key">
                </div>
                <div class="form-group">
                    <label>API Secret</label>
                    <input id="okx_secret" type="password" placeholder="è¾“å…¥OKX API Secret">
                </div>
                <div class="form-group">
                    <label>Passphrase</label>
                    <input id="okx_passphrase" type="password" placeholder="è¾“å…¥OKX Passphrase">
                </div>
                <button type="submit" class="btn">ğŸ’¾ ä¿å­˜OKXé…ç½®</button>
            </form>
            <hr style="margin: 20px 0;">
            
            <form id="walletForm" onsubmit="saveConfig(event, 'Wallet')">
                <h4>â›“ï¸ åŒºå—é“¾é’±åŒ…</h4>
                <div class="form-group">
                    <label>é’±åŒ…åœ°å€</label>
                    <input id="wallet_address" placeholder="è¾“å…¥ä»¥å¤ªåŠé’±åŒ…åœ°å€ (0x...)">
                </div>
                <div class="form-group">
                    <label>Etherscan API Key</label>
                    <input id="wallet_secret" type="password" placeholder="è¾“å…¥Etherscan API Key">
                    <small style="color: #999;">å…è´¹ç”³è¯·ï¼šhttps://etherscan.io/apis</small>
                </div>
                <button type="submit" class="btn">ğŸ’¾ ä¿å­˜é’±åŒ…é…ç½®</button>
            </form>
            
            <button class="btn" onclick="closeConfigModal()" style="margin-top: 20px; background: #999;">å…³é—­</button>
        </div>
    </div>
    
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <h3>åˆ›å»ºç”¨æˆ·</h3>
            <form id="createUserForm">
                <div class="form-group"><label>æ‰‹æœºå·</label><input id="createPhone" required></div>
                <p style="color: #999;">å¯†ç å°†è‡ªåŠ¨è®¾ç½®ä¸ºï¼šabc123456</p>
                <button type="submit" class="btn">åˆ›å»º</button>
                <button type="button" class="btn" onclick="closeCreateUserModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>
    
    <div id="rechargeModal" class="modal">
        <div class="modal-content">
            <h3>ç”¨æˆ·å……å€¼</h3>
            <form id="rechargeForm">
                <div class="form-group"><label>é€‰æ‹©ç”¨æˆ·</label><select id="rechargeUserId" required></select></div>
                <div class="form-group"><label>å……å€¼åˆ°</label>
                    <select id="rechargeAccount" required>
                        <option value="1">Binance</option>
                        <option value="2">OKX</option>
                        <option value="3">Wallet</option>
                    </select>
                </div>
                <div class="form-group"><label>é‡‘é¢</label><input type="number" id="rechargeAmount" required step="0.01"></div>
                <div class="form-group"><label>å¸ç§</label>
                    <select id="rechargeCurrency" required>
                        <option value="USDC">USDC</option>
                        <option value="USDT">USDT</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">ç¡®è®¤å……å€¼</button>
                <button type="button" class="btn" onclick="closeRechargeModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>
    
    <div id="userDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <h3>ğŸ‘¤ ç”¨æˆ·è¯¦æƒ…</h3>
            <input type="hidden" id="currentUserId">
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <strong>æ‰‹æœºå·ï¼š</strong><span id="detailPhone"></span>
                    </div>
                    <div>
                        <strong>çŠ¶æ€ï¼š</strong><span id="detailStatus"></span>
                    </div>
                    <div>
                        <strong>æ€»å……å€¼ï¼š</strong><span id="detailTotalRecharge"></span>
                    </div>
                    <div>
                        <strong>å½“å‰ä»·å€¼ï¼š</strong><span id="detailCurrentValue"></span>
                    </div>
                    <div>
                        <strong>æ€»ç›ˆäºï¼š</strong><span id="detailTotalProfit" style="font-weight: bold;"></span>
                    </div>
                    <div>
                        <strong>ç›ˆäºç‡ï¼š</strong><span id="detailProfitRate" style="font-weight: bold;"></span>
                    </div>
                </div>
            </div>
            
            <h4>ğŸ’° å……å€¼è®°å½•</h4>
            <table>
                <thead>
                    <tr>
                        <th>å……å€¼æ—¶é—´</th>
                        <th>é‡‘é¢</th>
                        <th>å¸ç§</th>
                        <th>å……å€¼åˆ°</th>
                        <th>å½“å‰ç›ˆäº</th>
                        <th>ç›ˆäºç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="rechargesBody"></tbody>
            </table>
            
            <button class="btn" onclick="closeUserDetailModal()" style="margin-top: 20px;">å…³é—­</button>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let authHeader = '';
        
        function checkAuth() {
            const phone = localStorage.getItem('phone');
            const password = localStorage.getItem('password');
            if (!phone || !password || phone !== 'admin') {
                window.location.href = '/';
                return false;
            }
            authHeader = 'Basic ' + btoa(phone + ':' + password);
            return true;
        }
        
        async function loadWallets() {
    const walletGrid = document.getElementById('walletGrid');
    
    // å®‰å…¨æ£€æŸ¥
    if (!walletGrid) {
        console.error('walletGrid å…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/admin/accounts/status`, { 
            headers: { 'Authorization': authHeader } 
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('é’±åŒ…æ•°æ®ï¼š', data);
            
            if (!data.accounts || data.accounts.length === 0) {
                walletGrid.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">æš‚æ— é’±åŒ…æ•°æ®</div>';
                return;
            }
            
            walletGrid.innerHTML = data.accounts.map(a => `
                <div class="wallet-card ${a.is_configured ? 'active' : ''}">
                    <h3>${a.account_type}</h3>
                    <div style="font-size: 14px; color: #666; margin: 5px 0;">
                        ${a.address || 'æœªé…ç½®'}
                    </div>
                    <div class="wallet-balance">$${a.current_balance.toFixed(2)}</div>
                    <div style="font-size: 13px; color: ${a.daily_change >= 0 ? '#10b981' : '#ef4444'};">
                        å˜åŒ–: ${a.daily_change >= 0 ? '+' : ''}$${a.daily_change.toFixed(2)} 
                        (${a.daily_change_rate >= 0 ? '+' : ''}${a.daily_change_rate.toFixed(2)}%)
                    </div>
                    <div style="font-size: 12px; margin-top: 10px; color: ${a.is_configured ? '#10b981' : '#999'};">
                        ${a.is_configured ? 'âœ“ å·²é…ç½®' : 'âš  æœªé…ç½®'}
                    </div>
                    ${a.is_configured ? `
                        <button class="btn" style="margin-top: 10px; font-size: 12px; padding: 5px 10px;" 
                                onclick="editConfig('${a.account_type}')">ä¿®æ”¹é…ç½®</button>
                    ` : ''}
                </div>
            `).join('');
        } else {
            console.error('è·å–é’±åŒ…çŠ¶æ€å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š', response.status);
            walletGrid.innerHTML = '<div style="padding: 40px; text-align: center; color: #ef4444;">åŠ è½½å¤±è´¥</div>';
        }
    } catch (error) {
        console.error('åŠ è½½é’±åŒ…å¤±è´¥ï¼š', error);
        walletGrid.innerHTML = '<div style="padding: 40px; text-align: center; color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
    }
}
        
async function loadUsers() {
    const tbody = document.getElementById('usersBody');
    const select = document.getElementById('rechargeUserId');
    
    // å®‰å…¨æ£€æŸ¥
    if (!tbody) {
        console.error('usersBody å…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/admin/users`, { 
            headers: { 'Authorization': authHeader } 
        });
        
        if (!response.ok) {
            console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š', response.status);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #ef4444;">åŠ è½½å¤±è´¥</td></tr>';
            return;
        }
        
        const data = await response.json();
        
        if (!data.users || data.users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
            if (select) select.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';
            return;
        }
        
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // ç§»åŠ¨ç«¯ï¼šå¡ç‰‡å¼å¸ƒå±€
            tbody.innerHTML = data.users.map(u => `
                <tr>
                    <td colspan="7">
                        <div class="mobile-card">
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">æ‰‹æœºå·</span>
                                <span class="mobile-card-value">${u.phone}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">æ€»å……å€¼</span>
                                <span class="mobile-card-value">$${u.total_recharge.toFixed(2)}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">å½“å‰ä»·å€¼</span>
                                <span class="mobile-card-value">$${u.current_value.toFixed(2)}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">ç›ˆäº</span>
                                <span class="mobile-card-value" style="color: ${u.total_profit >= 0 ? '#10b981' : '#ef4444'}">
                                    ${u.total_profit >= 0 ? '+' : ''}$${u.total_profit.toFixed(2)}
                                </span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">ç¬”æ•°</span>
                                <span class="mobile-card-value">${u.recharge_count}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">çŠ¶æ€</span>
                                <span class="badge ${u.is_active ? 'active' : 'inactive'}">
                                    ${u.is_active ? 'æ´»è·ƒ' : 'å·²åœç”¨'}
                                </span>
                            </div>
                            <div class="mobile-card-row">
                                <button class="btn" onclick="viewUserDetail(${u.user_id})" style="font-size: 12px; padding: 5px 10px; width: 48%; margin-right: 2%;">æŸ¥çœ‹</button>
                                <button class="btn" onclick="toggleUserStatus(${u.user_id})" style="font-size: 12px; padding: 5px 10px; width: 48%; background: ${u.is_active ? '#ef4444' : '#10b981'};">
                                    ${u.is_active ? 'åœç”¨' : 'å¯ç”¨'}
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else {
            // æ¡Œé¢ç«¯ï¼šè¡¨æ ¼å¸ƒå±€
            tbody.innerHTML = data.users.map(u => `
                <tr>
                    <td>${u.phone}</td>
                    <td>$${u.total_recharge.toFixed(2)}</td>
                    <td>$${u.current_value.toFixed(2)}</td>
                    <td style="color: ${u.total_profit >= 0 ? '#10b981' : '#ef4444'}">
                        ${u.total_profit >= 0 ? '+' : ''}$${u.total_profit.toFixed(2)}
                    </td>
                    <td>${u.recharge_count}</td>
                    <td>
                        <span class="badge ${u.is_active ? 'active' : 'inactive'}">
                            ${u.is_active ? 'æ´»è·ƒ' : 'å·²åœç”¨'}
                        </span>
                    </td>
                    <td>
                        <button class="btn" onclick="viewUserDetail(${u.user_id})" style="font-size: 12px; padding: 5px 10px;">æŸ¥çœ‹</button>
                        <button class="btn" onclick="toggleUserStatus(${u.user_id})" style="font-size: 12px; padding: 5px 10px; background: ${u.is_active ? '#ef4444' : '#10b981'};">
                            ${u.is_active ? 'åœç”¨' : 'å¯ç”¨'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
        if (select) {
            select.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>' + 
                data.users.filter(u => u.is_active).map(u => `<option value="${u.user_id}">${u.phone}</option>`).join('');
        }
    } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·å¤±è´¥ï¼š', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #ef4444;">åŠ è½½å¤±è´¥ï¼š' + error.message + '</td></tr>';
    }
}

// ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°åŠ è½½
let resizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        loadUsers();
    }, 250);
});

        
        function showConfigModal() { document.getElementById('configModal').classList.add('active'); }
        function closeConfigModal() { document.getElementById('configModal').classList.remove('active'); }
        function showCreateUserModal() { document.getElementById('createUserModal').classList.add('active'); }
        function closeCreateUserModal() { document.getElementById('createUserModal').classList.remove('active'); }
        function showRechargeModal() { document.getElementById('rechargeModal').classList.add('active'); }
        function closeRechargeModal() { document.getElementById('rechargeModal').classList.remove('active'); }
     
      // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
async function viewUserDetail(userId) {
    const response = await fetch(`${API_URL}/admin/users/${userId}`, {
        headers: { 'Authorization': authHeader }
    });
    
    if (response.ok) {
        const data = await response.json();
        showUserDetailModal(data);
    }
}

// åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
async function toggleUserStatus(userId) {
    if (!confirm('ç¡®è®¤è¦åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å—ï¼Ÿ')) return;
    
    const response = await fetch(`${API_URL}/admin/users/${userId}/status`, {
        method: 'PUT',
        headers: { 'Authorization': authHeader }
    });
    
    if (response.ok) {
        alert('ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°');
        loadUsers();
    }
}

// åˆ é™¤å……å€¼è®°å½•
async function deleteRecharge(rechargeId) {
    if (!confirm('ç¡®è®¤è¦åˆ é™¤è¿™ç¬”å……å€¼è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    
    const response = await fetch(`${API_URL}/admin/recharge/${rechargeId}`, {
        method: 'DELETE',
        headers: { 'Authorization': authHeader }
    });
    
    if (response.ok) {
        alert('å……å€¼è®°å½•å·²åˆ é™¤');
        // åˆ·æ–°å½“å‰æŸ¥çœ‹çš„ç”¨æˆ·è¯¦æƒ…
        const userId = document.getElementById('currentUserId').value;
        viewUserDetail(userId);
    }
}

// æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
function showUserDetailModal(data) {
    const modal = document.getElementById('userDetailModal');
    document.getElementById('currentUserId').value = data.user_id;
    document.getElementById('detailPhone').textContent = data.phone;
    document.getElementById('detailStatus').textContent = data.is_active ? 'æ´»è·ƒ' : 'å·²åœç”¨';
    document.getElementById('detailTotalRecharge').textContent = '$' + data.total_recharge.toFixed(2);
    document.getElementById('detailCurrentValue').textContent = '$' + data.current_value.toFixed(2);
    document.getElementById('detailTotalProfit').textContent = (data.total_profit >= 0 ? '+' : '') + '$' + data.total_profit.toFixed(2);
    document.getElementById('detailProfitRate').textContent = (data.profit_rate >= 0 ? '+' : '') + data.profit_rate.toFixed(2) + '%';
    
    const tbody = document.getElementById('rechargesBody');
    tbody.innerHTML = data.recharges.map(r => `
        <tr style="${r.is_active ? '' : 'opacity: 0.5; background: #f9f9f9;'}">
            <td>${new Date(r.recharge_at).toLocaleDateString('zh-CN')}</td>
            <td>$${r.amount.toFixed(2)}</td>
            <td>${r.currency}</td>
            <td>${r.account_type}</td>
            <td style="color: ${r.current_profit >= 0 ? '#10b981' : '#ef4444'}">
                ${r.current_profit >= 0 ? '+' : ''}$${r.current_profit.toFixed(2)}
            </td>
            <td style="color: ${r.current_rate >= 0 ? '#10b981' : '#ef4444'}">
                ${r.current_rate >= 0 ? '+' : ''}${r.current_rate.toFixed(2)}%
            </td>
            <td>
                ${r.is_active ? 
                    `<button class="btn" style="font-size: 12px; padding: 3px 8px; background: #ef4444;" onclick="deleteRecharge(${r.id})">åˆ é™¤</button>` :
                    '<span style="color: #999;">å·²åˆ é™¤</span>'
                }
            </td>
        </tr>
    `).join('');
    
    modal.classList.add('active');
}

function closeUserDetailModal() {
    document.getElementById('userDetailModal').classList.remove('active');
}  

async function saveConfig(e, type) {
    e.preventDefault();
    const config = { account_type: type };
    
    if (type === 'Wallet') {
        config.wallet_address = document.getElementById('wallet_address').value;
        config.api_secret = document.getElementById('wallet_secret').value; // Etherscan API Key
    } else if (type === 'OKX') {
        config.api_key = document.getElementById('okx_key').value;
        config.api_secret = document.getElementById('okx_secret').value;
        config.passphrase = document.getElementById('okx_passphrase').value;
    } else {
        config.api_key = document.getElementById(`${type.toLowerCase()}_key`).value;
        config.api_secret = document.getElementById(`${type.toLowerCase()}_secret`).value;
    }
    
    try {
        const response = await fetch(`${API_URL}/admin/accounts/config`, {
            method: 'POST',
            headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            alert(`âœ… ${type} é…ç½®ä¿å­˜æˆåŠŸï¼é…ç½®å·²æ°¸ä¹…ä¿å­˜ã€‚`);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            if (type === 'Binance') {
                document.getElementById('binance_key').value = '';
                document.getElementById('binance_secret').value = '';
            } else if (type === 'OKX') {
                document.getElementById('okx_key').value = '';
                document.getElementById('okx_secret').value = '';
                document.getElementById('okx_passphrase').value = '';
            } else if (type === 'Wallet') {
                document.getElementById('wallet_secret').value = '';
            }
            
            // è§¦å‘ä½™é¢æ£€æŸ¥
            try {
                await fetch(`${API_URL}/admin/manual-check`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader }
                });
            } catch (err) {
                console.log('ä½™é¢æ£€æŸ¥å¤±è´¥ï¼š', err);
            }
            
            // åˆ·æ–°é’±åŒ…æ˜¾ç¤º
            await loadWallets();
            
            console.log(`${type} é…ç½®å®Œæˆï¼Œæ•°æ®å·²åˆ·æ–°`);
        } else {
            const error = await response.json();
            alert('âŒ é…ç½®å¤±è´¥ï¼š' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            console.error('é…ç½®å¤±è´¥ï¼š', error);
        }
    } catch (error) {
        console.error('é…ç½®é”™è¯¯ï¼š', error);
        alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    }
}        
// ç¼–è¾‘é…ç½®ï¼ˆè‡ªåŠ¨å¡«å……å·²æœ‰å€¼ï¼‰
async function editConfig(accountType) {
    try {
        // è·å–å½“å‰é…ç½®
        const response = await fetch(`${API_URL}/admin/accounts/status`, {
            headers: { 'Authorization': authHeader }
        });
        
        if (response.ok) {
            const data = await response.json();
            const account = data.accounts.find(a => a.account_type === accountType);
            
            if (account && account.is_configured) {
                // æ˜¾ç¤ºé…ç½®æ¨¡æ€æ¡†
                showConfigModal();
                
                // ä¸è‡ªåŠ¨å¡«å……æ•æ„Ÿä¿¡æ¯ï¼Œåªæç¤ºå·²é…ç½®
                if (accountType === 'Binance') {
                    document.getElementById('binance_key').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                    document.getElementById('binance_secret').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                } else if (accountType === 'OKX') {
                    document.getElementById('okx_key').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                    document.getElementById('okx_secret').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                    document.getElementById('okx_passphrase').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                } else if (accountType === 'Wallet') {
                    // Walletåœ°å€å¯ä»¥æ˜¾ç¤º
                    document.getElementById('wallet_address').value = account.address || '';
                }
            }
        }
    } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥ï¼š', error);
    }
}

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const response = await fetch(`${API_URL}/admin/users`, {
                method: 'POST',
                headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: document.getElementById('createPhone').value })
            });
            if (response.ok) {
                alert('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼å¯†ç ï¼šabc123456');
                closeCreateUserModal();
                loadUsers();
            }
        });
        
        document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                user_id: parseInt(document.getElementById('rechargeUserId').value),
                admin_account_id: parseInt(document.getElementById('rechargeAccount').value),
                amount: parseFloat(document.getElementById('rechargeAmount').value),
                currency: document.getElementById('rechargeCurrency').value
            };
            const response = await fetch(`${API_URL}/admin/recharge`, {
                method: 'POST',
                headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                alert('å……å€¼æˆåŠŸï¼');
                closeRechargeModal();
                loadUsers();
            }
        });
        
        async function manualCheck() {
            const response = await fetch(`${API_URL}/admin/manual-check`, {
                method: 'POST',
                headers: { 'Authorization': authHeader }
            });
            if (response.ok) {
                alert('ä½™é¢æ£€æŸ¥å®Œæˆï¼');
                loadWallets();
                loadUsers();
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        async function loadRechargeStats() {
    const container = document.getElementById('rechargeStats');
    
    // å®‰å…¨æ£€æŸ¥
    if (!container) {
        console.error('rechargeStats å…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/admin/recharge/stats`, {
            headers: { 'Authorization': authHeader }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayRechargeStats(data);
        } else {
            console.error('åŠ è½½å……å€¼ç»Ÿè®¡å¤±è´¥ï¼š', response.status);
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æš‚æ— ç»Ÿè®¡æ•°æ®</div>';
        }
    } catch (error) {
        console.error('åŠ è½½å……å€¼ç»Ÿè®¡å¤±è´¥ï¼š', error);
        // é™é»˜å¤±è´¥ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æš‚æ— ç»Ÿè®¡æ•°æ®</div>';
    }
}

function displayRechargeStats(data) {
    const container = document.getElementById('rechargeStats');
    
    // æ·»åŠ å®‰å…¨æ£€æŸ¥
    if (!container) {
        console.error('rechargeStats å…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    // æ€»å……å€¼å¡ç‰‡
    let html = `
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px;">
            <h3 style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">ğŸ’° æ€»å……å€¼é‡‘é¢</h3>
            <div style="font-size: 32px; font-weight: bold;">$${data.total_recharges.toFixed(2)}</div>
        </div>
    `;
    
    // å„è´¦æˆ·å……å€¼ç»Ÿè®¡
    const accountTypes = ['Binance', 'OKX', 'Wallet'];
    const icons = { 'Binance': 'ğŸ…±ï¸', 'OKX': 'ğŸ…¾ï¸', 'Wallet': 'â›“ï¸' };
    
    accountTypes.forEach(type => {
        const stats = data.account_statistics[type];
        if (stats) {
            html += `
                <div class="stat-card" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e0e0e0;">
                    <h3 style="font-size: 16px; color: #667eea; margin-bottom: 15px;">${icons[type]} ${type}</h3>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #666;">USDC:</span>
                        <strong style="color: #10b981; margin-left: 10px;">$${stats.usdc.toFixed(2)}</strong>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #666;">USDT:</span>
                        <strong style="color: #10b981; margin-left: 10px;">$${stats.usdt.toFixed(2)}</strong>
                    </div>
                    <div style="border-top: 1px solid #e0e0e0; padding-top: 8px; margin-top: 8px;">
                        <span style="color: #666;">å°è®¡:</span>
                        <strong style="color: #333; margin-left: 10px;">$${stats.total.toFixed(2)}</strong>
                    </div>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
if (checkAuth()) {
    // ç¡®ä¿DOMå®Œå…¨åŠ è½½
    document.addEventListener('DOMContentLoaded', function() {
        loadWallets();
        loadUsers();
        loadRechargeStats();
    });
    
    // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆ
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        loadWallets();
        loadUsers();
        loadRechargeStats();
    }
    
    // å®šæ—¶åˆ·æ–°
    setInterval(() => { 
        loadWallets(); 
        loadUsers(); 
        loadRechargeStats();
    }, 30000);
}

    </script>
</body>
</html>
