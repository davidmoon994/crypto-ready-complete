<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .navbar h1 { font-size: 24px; }
        .navbar button { padding: 8px 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 8px; cursor: pointer; }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .section h2 { margin-bottom: 20px; color: #333; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .wallet-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .wallet-card { border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; }
        .wallet-card.active { border-color: #10b981; background: #f0fdf4; }
        .wallet-card h3 { color: #667eea; margin-bottom: 10px; }
        .wallet-balance { font-size: 24px; font-weight: bold; color: #10b981; margin: 15px 0; }
        .btn { padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 5px; }
        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: #10b981; }
        table { width: 100%; border-collapse: collapse; }
        table th { text-align: left; padding: 15px; background: #f8f9fa; font-weight: 600; color: #666; }
        table td { padding: 15px; border-bottom: 1px solid #e9ecef; }
        table tr:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>âš™ï¸ ç®¡ç†åå°</h1>
        <button onclick="logout()">é€€å‡º</button>
    </div>
    <div class="container">
        <div class="section">
            <h2>ğŸ’¼ é’±åŒ…çŠ¶æ€æ€»è§ˆ</h2>
            <div class="wallet-grid" id="walletGrid"></div>
            <button class="btn btn-success" onclick="manualCheck()">ğŸ”„ æ‰‹åŠ¨æ£€æŸ¥ä½™é¢</button>
            <button class="btn" onclick="showConfigModal()">âš™ï¸ é…ç½®é’±åŒ…</button>
        </div>
        <div class="section">
            <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
            <button class="btn" onclick="showCreateUserModal()">+ åˆ›å»ºç”¨æˆ·</button>
            <button class="btn btn-success" onclick="showRechargeModal()">ğŸ’° å……å€¼</button>
            <table><thead><tr><th>æ‰‹æœºå·</th><th>æ€»å……å€¼</th><th>å½“å‰ä»·å€¼</th><th>ç›ˆäº</th><th>ç¬”æ•°</th></tr></thead><tbody id="usersBody"></tbody></table>
        </div>
    </div>
    
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h3>âš™ï¸ é’±åŒ…é…ç½®</h3>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                â„¹ï¸ é…ç½®ä¸€æ¬¡åå°†æ°¸ä¹…ä¿å­˜ï¼Œé™¤éæ‰‹åŠ¨ä¿®æ”¹ã€‚APIå¯†é’¥å·²åŠ å¯†å­˜å‚¨ã€‚
            </p>
            
            <form id="binanceForm" onsubmit="saveConfig(event, 'Binance')">
                <h4>ğŸ…±ï¸ Binance</h4>
                <div class="form-group">
                    <label>API Key</label>
                    <input id="binance_key" type="password" placeholder="è¾“å…¥Binance API Key">
                    <small style="color: #999;">é¦–æ¬¡é…ç½®æˆ–éœ€è¦ä¿®æ”¹æ—¶å¡«å†™</small>
                </div>
                <div class="form-group">
                    <label>API Secret</label>
                    <input id="binance_secret" type="password" placeholder="è¾“å…¥Binance API Secret">
                </div>
                <button type="submit" class="btn">ğŸ’¾ ä¿å­˜Binanceé…ç½®</button>
            </form>
            <hr style="margin: 20px 0;">
            
            <form id="okxForm" onsubmit="saveConfig(event, 'OKX')">
                <h4>ğŸ…¾ï¸ OKX</h4>
                <div class="form-group">
                    <label>API Key</label>
                    <input id="okx_key" type="password" placeholder="è¾“å…¥OKX API Key">
                </div>
                <div class="form-group">
                    <label>API Secret</label>
                    <input id="okx_secret" type="password" placeholder="è¾“å…¥OKX API Secret">
                </div>
                <div class="form-group">
                    <label>Passphrase</label>
                    <input id="okx_passphrase" type="password" placeholder="è¾“å…¥OKX Passphrase">
                </div>
                <button type="submit" class="btn">ğŸ’¾ ä¿å­˜OKXé…ç½®</button>
            </form>
            <hr style="margin: 20px 0;">
            
            <form id="walletForm" onsubmit="saveConfig(event, 'Wallet')">
                <h4>â›“ï¸ åŒºå—é“¾é’±åŒ…</h4>
                <div class="form-group">
                    <label>é’±åŒ…åœ°å€</label>
                    <input id="wallet_address" placeholder="è¾“å…¥ä»¥å¤ªåŠé’±åŒ…åœ°å€ (0x...)">
                </div>
                <div class="form-group">
                    <label>Etherscan API Key</label>
                    <input id="wallet_secret" type="password" placeholder="è¾“å…¥Etherscan API Key">
                    <small style="color: #999;">å…è´¹ç”³è¯·ï¼šhttps://etherscan.io/apis</small>
                </div>
                <button type="submit" class="btn">ğŸ’¾ ä¿å­˜é’±åŒ…é…ç½®</button>
            </form>
            
            <button class="btn" onclick="closeConfigModal()" style="margin-top: 20px; background: #999;">å…³é—­</button>
        </div>
    </div>
    
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <h3>åˆ›å»ºç”¨æˆ·</h3>
            <form id="createUserForm">
                <div class="form-group"><label>æ‰‹æœºå·</label><input id="createPhone" required></div>
                <p style="color: #999;">å¯†ç å°†è‡ªåŠ¨è®¾ç½®ä¸ºï¼šabc123456</p>
                <button type="submit" class="btn">åˆ›å»º</button>
                <button type="button" class="btn" onclick="closeCreateUserModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>
    
    <div id="rechargeModal" class="modal">
        <div class="modal-content">
            <h3>ç”¨æˆ·å……å€¼</h3>
            <form id="rechargeForm">
                <div class="form-group"><label>é€‰æ‹©ç”¨æˆ·</label><select id="rechargeUserId" required></select></div>
                <div class="form-group"><label>å……å€¼åˆ°</label>
                    <select id="rechargeAccount" required>
                        <option value="1">Binance</option>
                        <option value="2">OKX</option>
                        <option value="3">Wallet</option>
                    </select>
                </div>
                <div class="form-group"><label>é‡‘é¢</label><input type="number" id="rechargeAmount" required step="0.01"></div>
                <div class="form-group"><label>å¸ç§</label>
                    <select id="rechargeCurrency" required>
                        <option value="USDC">USDC</option>
                        <option value="USDT">USDT</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">ç¡®è®¤å……å€¼</button>
                <button type="button" class="btn" onclick="closeRechargeModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin + '/api';
        let authHeader = '';
        
        function checkAuth() {
            const phone = localStorage.getItem('phone');
            const password = localStorage.getItem('password');
            if (!phone || !password || phone !== 'admin') {
                window.location.href = '/';
                return false;
            }
            authHeader = 'Basic ' + btoa(phone + ':' + password);
            return true;
        }
        
 async function loadWallets() {
    try {
        const response = await fetch(`${API_URL}/admin/accounts/status`, { 
            headers: { 'Authorization': authHeader } 
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('é’±åŒ…æ•°æ®ï¼š', data);
            
            const grid = document.getElementById('walletGrid');
            if (!data.accounts || data.accounts.length === 0) {
                grid.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">æš‚æ— é’±åŒ…æ•°æ®</div>';
                return;
            }
            
            grid.innerHTML = data.accounts.map(a => `
                <div class="wallet-card ${a.is_configured ? 'active' : ''}">
                    <h3>${a.account_type}</h3>
                    <div style="font-size: 14px; color: #666; margin: 5px 0;">
                        ${a.address || 'æœªé…ç½®'}
                    </div>
                    <div class="wallet-balance">$${a.current_balance.toFixed(2)}</div>
                    <div style="font-size: 13px; color: ${a.daily_change >= 0 ? '#10b981' : '#ef4444'};">
                        å˜åŒ–: ${a.daily_change >= 0 ? '+' : ''}$${a.daily_change.toFixed(2)} 
                        (${a.daily_change_rate >= 0 ? '+' : ''}${a.daily_change_rate.toFixed(2)}%)
                    </div>
                    <div style="font-size: 12px; margin-top: 10px; color: ${a.is_configured ? '#10b981' : '#999'};">
                        ${a.is_configured ? 'âœ“ å·²é…ç½®' : 'âš  æœªé…ç½®'}
                    </div>
                    ${a.is_configured ? `
                        <button class="btn" style="margin-top: 10px; font-size: 12px; padding: 5px 10px;" 
                                onclick="editConfig('${a.account_type}')">ä¿®æ”¹é…ç½®</button>
                    ` : ''}
                </div>
            `).join('');
        } else {
            console.error('è·å–é’±åŒ…çŠ¶æ€å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š', response.status);
            const error = await response.json();
            console.error('é”™è¯¯è¯¦æƒ…ï¼š', error);
        }
    } catch (error) {
        console.error('åŠ è½½é’±åŒ…å¤±è´¥ï¼š', error);
        document.getElementById('walletGrid').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
    }
}
        
async function loadUsers() {
    const response = await fetch(`${API_URL}/admin/users`, {
        headers: { 'Authorization': authHeader }
    });

    if (!response.ok) return;

    const data = await response.json();

    // å…¼å®¹ä¸‰ç§æƒ…å†µï¼š
    // 1ï¸âƒ£ è¿”å› { users: [...] }
    // 2ï¸âƒ£ è¿”å› [...]
    // 3ï¸âƒ£ è¿”å› null

    let users = [];

    if (Array.isArray(data)) {
        users = data;
    } else if (data && Array.isArray(data.users)) {
        users = data.users;
    }

    const tbody = document.getElementById('usersBody');
    const select = document.getElementById('rechargeUserId');

    if (!users.length) {
        tbody.innerHTML = `<tr><td colspan="5">æš‚æ— ç”¨æˆ·</td></tr>`;
        select.innerHTML = '<option value="">æš‚æ— ç”¨æˆ·</option>';
        return;
    }

    tbody.innerHTML = users.map(u => `
        <tr>
            <td>${u.phone}</td>
            <td>$${(u.total_recharge || 0).toFixed(2)}</td>
            <td>$${(u.current_value || 0).toFixed(2)}</td>
            <td style="color: ${(u.total_profit || 0) >= 0 ? '#10b981' : '#ef4444'}">
                ${(u.total_profit || 0) >= 0 ? '+' : ''}$${(u.total_profit || 0).toFixed(2)}
            </td>
            <td>${u.recharge_count || 0}</td>
        </tr>
    `).join('');

    select.innerHTML =
        '<option value="">é€‰æ‹©ç”¨æˆ·</option>' +
        users.map(u =>
            `<option value="${u.user_id}">${u.phone}</option>`
        ).join('');
}

        
        function showConfigModal() { document.getElementById('configModal').classList.add('active'); }
        function closeConfigModal() { document.getElementById('configModal').classList.remove('active'); }
        function showCreateUserModal() { document.getElementById('createUserModal').classList.add('active'); }
        function closeCreateUserModal() { document.getElementById('createUserModal').classList.remove('active'); }
        function showRechargeModal() { document.getElementById('rechargeModal').classList.add('active'); }
        function closeRechargeModal() { document.getElementById('rechargeModal').classList.remove('active'); }
        
async function saveConfig(e, type) {
    e.preventDefault();
    const config = { account_type: type };
    
    if (type === 'Wallet') {
        config.wallet_address = document.getElementById('wallet_address').value;
        config.api_secret = document.getElementById('wallet_secret').value; // Etherscan API Key
    } else if (type === 'OKX') {
        config.api_key = document.getElementById('okx_key').value;
        config.api_secret = document.getElementById('okx_secret').value;
        config.passphrase = document.getElementById('okx_passphrase').value;
    } else {
        config.api_key = document.getElementById(`${type.toLowerCase()}_key`).value;
        config.api_secret = document.getElementById(`${type.toLowerCase()}_secret`).value;
    }
    
    try {
        const response = await fetch(`${API_URL}/admin/accounts/config`, {
            method: 'POST',
            headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            alert(`âœ… ${type} é…ç½®ä¿å­˜æˆåŠŸï¼é…ç½®å·²æ°¸ä¹…ä¿å­˜ã€‚`);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            if (type === 'Binance') {
                document.getElementById('binance_key').value = '';
                document.getElementById('binance_secret').value = '';
            } else if (type === 'OKX') {
                document.getElementById('okx_key').value = '';
                document.getElementById('okx_secret').value = '';
                document.getElementById('okx_passphrase').value = '';
            } else if (type === 'Wallet') {
                document.getElementById('wallet_secret').value = '';
            }
            
            // è§¦å‘ä½™é¢æ£€æŸ¥
            try {
                await fetch(`${API_URL}/admin/manual-check`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader }
                });
            } catch (err) {
                console.log('ä½™é¢æ£€æŸ¥å¤±è´¥ï¼š', err);
            }
            
            // åˆ·æ–°é’±åŒ…æ˜¾ç¤º
            await loadWallets();
            
            console.log(`${type} é…ç½®å®Œæˆï¼Œæ•°æ®å·²åˆ·æ–°`);
        } else {
            const error = await response.json();
            alert('âŒ é…ç½®å¤±è´¥ï¼š' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            console.error('é…ç½®å¤±è´¥ï¼š', error);
        }
    } catch (error) {
        console.error('é…ç½®é”™è¯¯ï¼š', error);
        alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    }
}        
// ç¼–è¾‘é…ç½®ï¼ˆè‡ªåŠ¨å¡«å……å·²æœ‰å€¼ï¼‰
async function editConfig(accountType) {
    try {
        // è·å–å½“å‰é…ç½®
        const response = await fetch(`${API_URL}/admin/accounts/status`, {
            headers: { 'Authorization': authHeader }
        });
        
        if (response.ok) {
            const data = await response.json();
            const account = data.accounts.find(a => a.account_type === accountType);
            
            if (account && account.is_configured) {
                // æ˜¾ç¤ºé…ç½®æ¨¡æ€æ¡†
                showConfigModal();
                
                // ä¸è‡ªåŠ¨å¡«å……æ•æ„Ÿä¿¡æ¯ï¼Œåªæç¤ºå·²é…ç½®
                if (accountType === 'Binance') {
                    document.getElementById('binance_key').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                    document.getElementById('binance_secret').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                } else if (accountType === 'OKX') {
                    document.getElementById('okx_key').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                    document.getElementById('okx_secret').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                    document.getElementById('okx_passphrase').placeholder = 'å·²é…ç½®ï¼ˆå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰';
                } else if (accountType === 'Wallet') {
                    // Walletåœ°å€å¯ä»¥æ˜¾ç¤º
                    document.getElementById('wallet_address').value = account.address || '';
                }
            }
        }
    } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥ï¼š', error);
    }
}

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const response = await fetch(`${API_URL}/admin/users`, {
                method: 'POST',
                headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: document.getElementById('createPhone').value })
            });
            if (response.ok) {
                alert('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼å¯†ç ï¼šabc123456');
                closeCreateUserModal();
                loadUsers();
            }
        });
        
        document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                user_id: parseInt(document.getElementById('rechargeUserId').value),
                admin_account_id: parseInt(document.getElementById('rechargeAccount').value),
                amount: parseFloat(document.getElementById('rechargeAmount').value),
                currency: document.getElementById('rechargeCurrency').value
            };
            const response = await fetch(`${API_URL}/admin/recharge`, {
                method: 'POST',
                headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                alert('å……å€¼æˆåŠŸï¼');
                closeRechargeModal();
                loadUsers();
            }
        });
        
        async function manualCheck() {
            const response = await fetch(`${API_URL}/admin/manual-check`, {
                method: 'POST',
                headers: { 'Authorization': authHeader }
            });
            if (response.ok) {
                alert('ä½™é¢æ£€æŸ¥å®Œæˆï¼');
                loadWallets();
                loadUsers();
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        if (checkAuth()) {
            loadWallets();
            loadUsers();
            setInterval(() => { loadWallets(); loadUsers(); }, 30000);
        }
    </script>
</body>
</html>
